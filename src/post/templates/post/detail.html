{% extends 'base.html' %}

{% block title %}{{ post.title }}{% endblock title %}

{% block content %}
  <div class="row mt-4 form mx-md-3 d-flex justify-content-between align-content-center">
    <div class="col-md-6 order-md-0 order-1 mt-0 mt-md-4">
      <div class="row mt-md-3 mt-1 mb-4 d-flex justify-content-center align-content-center align-items-center">
        <div id="like-button" class="like col-6 d-flex" data-action="{% if request.user in post.users_like.all %}un{% endif %}like">
          <div id="liked-svg" class="liked" {% if request.user not in post.users_like.all %}hidden{% endif %}>
            <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="768.000000pt" height="768.000000pt" viewBox="0 0 768.000000 768.000000" preserveAspectRatio="xMidYMid meet">
              <g transform="translate(0.000000,768.000000) scale(0.100000,-0.100000)" stroke="none">
                <path d="M4545 6816 c-82 -19 -183 -66 -261 -121 -87 -62 -120 -106 -744 -975
                -574 -801 -595 -827 -976 -1220 -250 -259 -263 -275 -275 -347 -6 -34 -12
                -563 -16 -1285 l-5 -1227 50 -69 c73 -97 462 -478 547 -534 148 -97 288 -151
                441 -170 153 -18 2198 -18 2279 1 97 21 209 68 292 123 101 65 258 224 300
                303 76 145 842 1872 985 2220 99 242 102 259 100 570 -1 148 -7 284 -13 315
                -47 229 -268 464 -497 526 -77 21 -493 33 -1188 33 l-542 1 85 213 c268 677
                299 787 273 963 -51 337 -249 585 -527 662 -98 28 -232 35 -308 18z"/>
                <path d="M910 4519 c-201 -58 -333 -164 -451 -363 l-59 -100 0 -1248 0 -1249
                26 -52 c97 -191 248 -338 409 -399 54 -20 78 -23 240 -22 l180 0 75 32 c162
                70 286 193 371 369 l49 102 0 1218 0 1218 -50 100 c-94 187 -230 312 -402 370
                -71 24 -102 28 -218 31 -74 2 -151 -1 -170 -7z"/>
              </g>
            </svg>
          </div>
          <div id="default-svg" class="default" {% if request.user in post.users_like.all %}hidden{% endif %}>
            <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="768.000000pt" height="768.000000pt" viewBox="0 0 768.000000 768.000000" preserveAspectRatio="xMidYMid meet">
              <g transform="translate(0.000000,768.000000) scale(0.100000,-0.100000)" stroke="none">
                <path d="M4545 6816 c-82 -19 -183 -66 -261 -121 -87 -62 -120 -106 -744 -975
                -574 -801 -595 -827 -976 -1220 -250 -259 -263 -275 -275 -347 -6 -34 -12
                -563 -16 -1285 l-5 -1227 50 -69 c73 -97 462 -478 547 -534 148 -97 288 -151
                441 -170 153 -18 2198 -18 2279 1 97 21 209 68 292 123 101 65 258 224 300
                303 76 145 842 1872 985 2220 99 242 102 259 100 570 -1 148 -7 284 -13 315
                -47 229 -268 464 -497 526 -77 21 -493 33 -1188 33 l-542 1 85 213 c268 677
                299 787 273 963 -51 337 -249 585 -527 662 -98 28 -232 35 -308 18z m240 -231
                c171 -45 303 -192 355 -399 46 -183 40 -209 -236 -913 -85 -216 -154 -406
                -154 -422 0 -46 19 -78 59 -98 33 -16 103 -18 931 -24 515 -4 913 -11 937 -16
                115 -27 225 -112 296 -230 60 -101 62 -112 62 -403 0 -262 0 -266 -27 -341
                -55 -156 -322 -770 -765 -1759 l-267 -595 -90 -90 c-104 -103 -185 -154 -302
                -191 l-81 -25 -1109 3 -1109 4 -86 32 c-142 54 -223 109 -385 260 -154 143
                -272 264 -299 306 -14 21 -15 148 -13 1223 l3 1199 30 36 c17 20 131 142 256
                271 345 358 338 350 988 1255 557 775 583 809 661 860 36 23 85 49 110 57 61
                18 163 18 235 0z"/>
                <path d="M910 4519 c-201 -58 -333 -164 -451 -363 l-59 -100 0 -1248 0 -1249
                26 -52 c97 -191 248 -338 409 -399 54 -20 78 -23 240 -22 l180 0 75 32 c162
                70 286 193 371 369 l49 102 0 1218 0 1218 -50 100 c-94 187 -230 312 -402 370
                -71 24 -102 28 -218 31 -74 2 -151 -1 -170 -7z"/>
              </g>
            </svg>
          </div>
        </div>
        <div class="author col-6">
          <a href="{{ post.user.get_absolute_url }}" class="">
            <div class="d-flex flex-row-reverse">
              {% load thumbnail %}
              <img src="{% thumbnail post.user.profile.photo 240x0 %}" class="img-thumbnail rounded-circle mini-img">
              <div class="mx-2 d-flex flex-column justify-content-center align-content-center">
                <span class="text-end username bold-font">{{ post.user.username }}</span>
                <span>{{ post.user.posts.count }} پست</span>
              </div>
            </div>
          </a>
        </div>
      </div>
      <div dir="auto">
        {{ post.description|linebreaks }}
      </div>
      <hr>
      <div class="row">
        <div class="col-6 text-start">
          <span id="total-like">
            {{ post.users_like.count }}
          </span>
          لایک
        </div>
        <div class="col-6 text-end">
          {{ post.created }}
        </div>
      </div>
      <br>
      <br>
      {% if post.users_like.exists %}
      <h5 class="bold-font">افرادی که این پست رو پسندیدند</h5>
      <div id="like-profile-list" class="row mt-4">
        {% for user in post.users_like.all %}
          <div class="col-md-4 col-6 mb-5">
            <a class="text-center d-flex flex-column justify-content-center align-content-center" href="{{ user.get_absolute_url }}">
              <div>
                {% load thumbnail %}
                <img src="{% thumbnail user.profile.photo 240x0 %}" class="img-thumbnail rounded-circle mini-img">
              </div>
              <div>
                <span class="mini-username bold-font text-center">{{ user.username }}</span>
              </div>
            </a>
          </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    <div class="col-md-5 order-md-1 order-0 mb-md-0 mb-2 mt-md-4 mt-2">
      <img src="{{ post.image.url }}" class="w-100 rounded img-thumbnail" alt="تصویر پست">
    </div>
  </div>
  <div id="csrf" hidden>
    {% csrf_token %}
  </div>
  <div hidden>
    <div id="new-profile" class="col-md-4 col-6 mb-5">
      <a class="text-center d-flex flex-column justify-content-center align-content-center" href="">
        <div>
          {% load thumbnail %}
          <img src="{% thumbnail request.user.profile.photo 240x0 %}" class="img-thumbnail rounded-circle mini-img">
        </div>
        <div class="mt-1">
          <span class="mini-username bold-font text-center">{{ request.user.username }}</span>
        </div>
      </a>
    </div>
  </div>
  <div class="py-5"></div>
{% endblock content %}

{% block script %}
<script>
  function like() {
    var csrf = document.getElementById("csrf").querySelector("input").value;
    var likeButton = document.getElementById("like-button");
    var likeCount = document.getElementById("total-like");
    var newProfile = document.getElementById("new-profile");
    var usersProfile = document.getElementById("like-profile-list");
    likeButton.onclick = function (e) {
      var request = new XMLHttpRequest();
      var action = this.dataset.action;
      request.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          try {
            var response = JSON.parse(this.responseText);
          } catch (error) {
            window.location.replace("{% url 'account:login' %}?next={{ request.path }}");
          }
          if (response["status"] == "OK") {
            if (action == "like") {
              likeButton.dataset.action = "unlike";
              document.getElementById("liked-svg").hidden = false;
              document.getElementById("default-svg").hidden = true;
              likeCount.innerText = parseInt(likeCount.innerText) + 1;
              usersProfile.innerHTML =
                newProfile.outerHTML + usersProfile.innerHTML;
            } else {
              likeButton.dataset.action = "like";
              document.getElementById("liked-svg").hidden = true;
              document.getElementById("default-svg").hidden = false;
              likeCount.innerText = parseInt(likeCount.innerText) - 1;
              usersProfile.removeChild(usersProfile.firstElementChild);
            }
          } else {
            console.log("you can not like this post");
          }
        }
      };
      request.onerror = function () {
        var messages = document.getElementById("messages");
        messages.innerHTML = `<div class="messages d-grid gap-2 mx-4">
          <div class="alert alert-danger alert-dismissible fade show my-2" role="alert">
            خطا در ارتباط با سرور!
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        </div>`;
      };
      request.open("POST", "{% url 'post:like' post.slug %}", true);
      request.setRequestHeader("X-CSRFToken", csrf);
      request.setRequestHeader("x-requested-with", "XMLHttpRequest");
      var data = new FormData();
      data.append("action", action);
      request.send(data);
    };
  }
  window.ready(like);
</script> 
{% endblock script %}
